<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatMeNow - WebSocket Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 800px;
        height: 90vh;
        display: flex;
        flex-direction: column;
      }
      .header {
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px 20px 0 0;
      }
      .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }
      .connection {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .connection input {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
      }
      .connection button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background: #48bb78;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }
      .connection button:hover {
        background: #38a169;
      }
      .connection button.disconnect {
        background: #f56565;
      }
      .connection button.disconnect:hover {
        background: #e53e3e;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f7fafc;
      }
      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 70%;
        animation: slideIn 0.3s ease;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message.sent {
        background: #667eea;
        color: white;
        margin-left: auto;
      }
      .message.received {
        background: white;
        border: 1px solid #e2e8f0;
      }
      .message.system {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        max-width: 100%;
        text-align: center;
        font-size: 13px;
      }
      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
      }
      .input-area {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        background: white;
        border-radius: 0 0 20px 20px;
      }
      .input-group {
        display: flex;
        gap: 10px;
      }
      .input-group input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
      }
      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }
      .input-group button {
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        background: #667eea;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }
      .input-group button:hover {
        background: #5a67d8;
      }
      .status {
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
      }
      .status.connected {
        background: #c6f6d5;
        color: #22543d;
      }
      .status.disconnected {
        background: #fed7d7;
        color: #742a2a;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ChatMeNow - WebSocket Test</h1>
        <div class="connection">
          <input
            type="text"
            id="token"
            placeholder="Paste your JWT token here..."
          />
          <input
            type="text"
            id="conversationId"
            placeholder="Conversation ID"
          />
          <button id="connectBtn" onclick="connect()">Connect</button>
        </div>
        <div style="margin-top: 10px">
          <span class="status disconnected" id="status">Disconnected</span>
        </div>
      </div>

      <div class="messages" id="messages">
        <div class="message system">
          Welcome to ChatMeNow! ðŸ‘‹<br />
          1. Get your JWT token from API (POST /api/auth/login)<br />
          2. Paste it above and click Connect<br />
          3. Start chatting!
        </div>
      </div>

      <div class="input-area">
        <div class="input-group">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
            disabled
          />
          <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let conversationId = null;
      let currentUserId = null;

      function parseJWT(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join(""),
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      function connect() {
        const token = document.getElementById("token").value;
        conversationId = document.getElementById("conversationId").value;

        if (!token) {
          alert("Please enter a JWT token");
          return;
        }

        if (!conversationId) {
          alert("Please enter a conversation ID");
          return;
        }

        // Parse JWT to get userId
        const payload = parseJWT(token);
        if (payload && payload.sub) {
          currentUserId = payload.sub;
          console.log("Current User ID:", currentUserId);
        }

        const wsUrl = `ws://localhost:8080/ws?token=${token}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          document.getElementById("status").textContent = "Connected";
          document.getElementById("status").className = "status connected";
          document.getElementById("connectBtn").textContent = "Disconnect";
          document.getElementById("connectBtn").className =
            "connection button disconnect";
          document.getElementById("connectBtn").onclick = disconnect;
          document.getElementById("messageInput").disabled = false;
          document.getElementById("sendBtn").disabled = false;

          addSystemMessage("Connected to ChatMeNow! ðŸŽ‰");

          // Join conversation
          ws.send(
            JSON.stringify({
              type: "join_conversation",
              payload: { conversationId },
            }),
          );

          addSystemMessage(`Joined conversation: ${conversationId}`);
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log("Received:", data);

          if (data.type === "new_message") {
            const isMine = data.payload.senderId === currentUserId;
            addMessage(
              data.payload.content,
              isMine ? "sent" : "received",
              isMine ? "You" : data.payload.senderId,
            );
          } else if (data.type === "user_typing") {
            if (
              data.payload.isTyping &&
              data.payload.userId !== currentUserId
            ) {
              addSystemMessage(`User ${data.payload.userId} is typing...`);
            }
          }
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          addSystemMessage("Connection error! âŒ");
        };

        ws.onclose = () => {
          document.getElementById("status").textContent = "Disconnected";
          document.getElementById("status").className = "status disconnected";
          document.getElementById("connectBtn").textContent = "Connect";
          document.getElementById("connectBtn").className = "connection button";
          document.getElementById("connectBtn").onclick = connect;
          document.getElementById("messageInput").disabled = true;
          document.getElementById("sendBtn").disabled = true;

          addSystemMessage("Disconnected from server");
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
        }
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message || !ws) return;

        ws.send(
          JSON.stringify({
            type: "send_message",
            payload: {
              conversationId,
              content: message,
            },
          }),
        );

        addMessage(message, "sent", "You");
        input.value = "";
      }

      function addMessage(content, type, sender) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const now = new Date().toLocaleTimeString();
        messageDiv.innerHTML = `
                <div>${content}</div>
                <div class="message-time">${sender} â€¢ ${now}</div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(content) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message system";
        messageDiv.textContent = content;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Send message on Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Typing indicator
      let typingTimeout;
      document.getElementById("messageInput").addEventListener("input", () => {
        if (!ws || !conversationId) return;

        clearTimeout(typingTimeout);

        ws.send(
          JSON.stringify({
            type: "typing",
            payload: { conversationId, isTyping: true },
          }),
        );

        typingTimeout = setTimeout(() => {
          ws.send(
            JSON.stringify({
              type: "typing",
              payload: { conversationId, isTyping: false },
            }),
          );
        }, 1000);
      });
    </script>
  </body>
</html>
